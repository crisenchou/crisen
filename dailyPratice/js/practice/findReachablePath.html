<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>寻找最短可行路径</title>
    <style>
        #map {
            height: 400px;
            width: 400px;
        }
    </style>
</head>
<body>
<div>
    <canvas id="map"></canvas>
</div>
<div>
    <input type="button" value="设置障碍"/>
    <input type="button" value="设置起点/终点"/>
    <input id="run" type="button" value="开始寻路" onclick="run()"/>
</div>
</body>
<script>


    //寻路方向
    var direction = [
        [0, 1], //east
        [1, 0],//south
        [0, -1],//west
        [-1, 0]//north
    ];

    //判断边界
    function inMap(x, y) {
        return (x >= 0 && y >= 0 && x < 10 && y < 10)
    }

    //地图结点
    function MapNode(x, y, reachable, value) {
        this.x = x;
        this.y = y;
        this.reachable = reachable;
        this.sur = null;
        this.value = value;
    }

    //初始化图
    function initGraph(table) {
        var g = new Array(10);
        var i, j;
        for (i = 0; i < 10; i++) {
            g[i] = new Array(10);
            for (j = 0; j < 10; j++) {
                var node = new MapNode(i, j, 0, 0);
                node.value = table[i][j];
                if (table[i][j] == 0) {
                    node.reachable = 1;
                }
                g[i][j] = node;
            }
        }
        return g;
    }


    function nodeExist(p, close) {
        if (close.length) {
            for (var i in close) {
                if (close[i].x == p.x && close[i].y == p.y) {
                    return true;
                }
            }
        }
        return false;
    }


    function dijkstra(graph, startX, startY, endX, endY) {
        var open = [];
        var close = [];
        open.push(graph[startX][startY]);
        var times = 0;
        while (open.length) {
            var p = open.shift();
            var curX = p.x;
            var curY = p.y;
            var surX, surY;
            if (nodeExist(p, close)) {
                continue;
            }

            if (p.x == endX && p.y == endY) {
                break;
            }

            for (var i = 0; i < 4; i++) {
                surX = curX + direction[i][0];
                surY = curY + direction[i][1];
                if (!inMap(surX, surY)) {
                    continue;
                }
                if (nodeExist(graph[surX][surY], open)) {
                    continue;
                }
                if (nodeExist(graph[surX][surY], close)) {
                    continue;
                }
                if (graph[surX][surY].reachable) {
                    graph[surX][surY].sur = p;
                    open.push(graph[surX][surY]);
                    times++;
                }
            }
            close.push(p);
        }
        return graph;
    }


    // 0 能访问  1 障碍  2 路径点  3 起点  4 终点

    var table = [
        [0, 0, 1, 0, 1, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 1, 0, 0, 0, 0, 0],
        [0, 0, 0, 1, 0, 0, 0, 0, 0, 0],
        [0, 0, 1, 1, 1, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
    ];


    function Map(canvas) {
        this.canvas = document.getElementById(canvas);
        this.brush = new Draw(canvas);
        this.init = function (table) {
            this.drawMap(table);
            //this.brush.drawDot(0, 0, 'red', this.canvas.offsetHeight, this.canvas.offsetWidth);//初始化画布
        }

        this.drawMap = function (table) {
            //console.log(table);

            var colorSet = ['white', 'black', 'green', 'blue', 'red']

            for (var i = 0; i < 10; i++) {
                for (var j = 0; j < 10; j++) {
                    var x = i * 15;
                    var y = j * 15;
                    var crlorful = colorSet[table[i][j]];
                    this.brush.drawDot(y, x, crlorful, 10, 5)
                }
            }
        }

        this.run = function (table) {
            var graph = initGraph(table);
            graph = dijkstra(graph, 0, 0, 8, 8);
            var dest = graph[8][8];
            while (dest.sur != null) {
                //console.log(dest.x, dest.y);
                dest = dest.sur;
                table[dest.x][dest.y] = 2;
            }
            this.drawMap(table);
        }
    }

    function Draw(canvas) {
        this.cxt = document.getElementById(canvas).getContext("2d");
        this.drawDot = function (x, y, color, length, size) {
            length = length || 10;
            size = size || 10;
            this.cxt.fillStyle = color;
            //this.cxt.strokeRect(x, y, length, size);
            this.cxt.fillRect(x, y, length, size);
        }
    }

    var map = new Map('map');
    map.init(table);
    function run() {
        map.run(table);
    }


</script>
</html>